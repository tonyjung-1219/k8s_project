# ---------------------------------------------------------
# NAMESPACES
# ---------------------------------------------------------
apiVersion: v1
kind: Namespace
metadata:
  name: falco
---
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
# ---------------------------------------------------------
# FALCO CONFIGMAP (falco.yaml)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco
  namespace: falco
data:
  falco.yaml: |-
    append_output:
    - suggested_output: true
    base_syscalls:
      all: false
      custom_set: []
      repair: false
    buffer_format_base64: false
    buffered_outputs: false
    capture:
      default_duration: 5000
      enabled: false
      mode: rules
      path_prefix: /tmp/falco
    config_files:
    - /etc/falco/config.d
    engine:
      ebpf:
        buf_size_preset: 4
        drop_failed_exit: false
        probe: ${HOME}/.falco/falco-bpf.o
      kind: modern_ebpf
      kmod:
        buf_size_preset: 4
        drop_failed_exit: false
      modern_ebpf:
        buf_size_preset: 4
        cpus_for_each_buffer: 2
        drop_failed_exit: false
    falco_libs:
      snaplen: 80
      thread_table_auto_purging_interval_s: 300
      thread_table_auto_purging_thread_timeout_s: 300
      thread_table_size: 262144
    file_output:
      enabled: false
      filename: ./events.txt
      keep_alive: false
    grpc:
      bind_address: unix:///run/falco/falco.sock
      enabled: false
      threadiness: 0
    grpc_output:
      enabled: false
    http_output:
      ca_bundle: ""
      ca_cert: ""
      ca_path: /etc/falco/certs/
      client_cert: /etc/falco/certs/client/client.crt
      client_key: /etc/falco/certs/client/client.key
      compress_uploads: false
      echo: false
      enabled: false
      insecure: false
      keep_alive: false
      max_consecutive_timeouts: 5
      mtls: false
      url: ""
      user_agent: falcosecurity/falco
    json_include_message_property: false
    json_include_output_fields_property: true
    json_include_output_property: true
    json_include_tags_property: true
    json_output: false
    libs_logger:
      enabled: true
      severity: info
    load_plugins:
    - container
    log_level: info
    log_stderr: true
    log_syslog: true
    metrics:
      enabled: true
      http_port: 8765
      http_server: true
      interval: 1s
      output_type: prometheus
    output_timeout: 2000
    outputs_queue:
      capacity: 0
    plugins:
    - init_config:
        engines:
          bpm:
            enabled: true
          containerd:
            enabled: true
            sockets:
            - /run/host-containerd/containerd.sock
          cri:
            enabled: true
            sockets:
            - /run/containerd/containerd.sock
            - /run/crio/crio.sock
            - /run/k3s/containerd/containerd.sock
            - /run/host-containerd/containerd.sock
          docker:
            enabled: true
            sockets:
            - /var/run/docker.sock
          libvirt_lxc:
            enabled: true
          lxc:
            enabled: true
          podman:
            enabled: true
            sockets:
            - /run/podman/podman.sock
        hooks:
        - create
        label_max_len: 100
        with_size: false
      library_path: libcontainer.so
      name: container
    plugins_hostinfo: true
    priority: debug
    program_output:
      enabled: false
      keep_alive: false
      program: 'jq ''{text: .output}'' | curl -d @- -X POST https://hooks.slack.com/services/XXX'
    rule_matching: first
    rules_files:
    - /etc/falco/falco_rules.yaml
    - /etc/falco/falco_rules.local.yaml
    - /etc/falco/rules.d
    stdout_output:
      enabled: true
    syscall_event_drops:
      actions:
      - log
      - alert
      max_burst: 1
      rate: 0.03333
      simulate_drops: false
      threshold: 0.1
    syscall_event_timeouts:
      max_consecutives: 1000
    syslog_output:
      enabled: true
    time_format_iso_8601: false
    watch_config_files: true
    webserver:
      enabled: true
      k8s_healthz_endpoint: /healthz
      listen_address: 0.0.0.0
      listen_port: 8765
      prometheus_metrics_enabled: true
      ssl_certificate: /etc/falco/falco.pem
      ssl_enabled: false
      threadiness: 0
---
# ---------------------------------------------------------
# FALCO SERVICE ACCOUNTS
# ---------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: falco
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falcosidekick
  namespace: falco
---
# ---------------------------------------------------------
# FALCO DAEMONSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: falco
      app.kubernetes.io/name: falco
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: falco
        app.kubernetes.io/name: falco
    spec:
      serviceAccountName: falco
      containers:
      - name: falco
        image: docker.io/falcosecurity/falco:0.42.1
        imagePullPolicy: IfNotPresent
        args: ["/usr/bin/falco"]
        env:
        - name: HOST_ROOT
          value: /host
        - name: FALCO_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: FALCO_K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        ports:
        - name: web
          containerPort: 8765
        securityContext:
          privileged: true
        volumeMounts:
        - name: container-engine-socket-0
          mountPath: /host/var/run/docker.sock
        - name: container-engine-socket-1
          mountPath: /host/run/podman/podman.sock
        - name: container-engine-socket-2
          mountPath: /host/run/host-containerd/containerd.sock
        - name: container-engine-socket-3
          mountPath: /host/run/containerd/containerd.sock
        - name: container-engine-socket-4
          mountPath: /host/run/crio/crio.sock
        - name: container-engine-socket-5
          mountPath: /host/run/k3s/containerd/containerd.sock
        - name: rulesfiles-install-dir
          mountPath: /etc/falco
        - name: plugins-install-dir
          mountPath: /usr/share/falco/plugins
        - name: specialized-falco-configs
          mountPath: /etc/falco/config.d
        - name: root-falco-fs
          mountPath: /root/.falco
        - name: proc-fs
          mountPath: /host/proc
        - name: etc-fs
          mountPath: /host/etc
          readOnly: true
        - name: dev-fs
          mountPath: /host/dev
          readOnly: true
        - name: sys-module-fs
          mountPath: /sys/module
        - name: sys-fs
          mountPath: /sys/kernel
          readOnly: true
        - name: falco-yaml
          mountPath: /etc/falco/falco.yaml
          subPath: falco.yaml
      initContainers:
      - name: falco-driver-loader
        image: docker.io/falcosecurity/falco-driver-loader:0.42.1
        securityContext:
          privileged: true
        args: ["auto"]
        env:
        - name: HOST_ROOT
          value: /host
        volumeMounts:
        - name: root-falco-fs
          mountPath: /root/.falco
      volumes:
      - name: container-engine-socket-0
        hostPath: { path: /var/run/docker.sock }
      - name: container-engine-socket-1
        hostPath: { path: /run/podman/podman.sock }
      - name: container-engine-socket-2
        hostPath: { path: /run/host-containerd/containerd.sock }
      - name: container-engine-socket-3
        hostPath: { path: /run/containerd/containerd.sock }
      - name: container-engine-socket-4
        hostPath: { path: /run/crio/crio.sock }
      - name: container-engine-socket-5
        hostPath: { path: /run/k3s/containerd/containerd.sock }
      - name: rulesfiles-install-dir
        emptyDir: {}
      - name: plugins-install-dir
        emptyDir: {}
      - name: specialized-falco-configs
        emptyDir: {}
      - name: root-falco-fs
        emptyDir: {}
      - name: proc-fs
        hostPath: { path: /proc }
      - name: etc-fs
        hostPath: { path: /etc }
      - name: dev-fs
        hostPath: { path: /dev }
      - name: sys-module-fs
        hostPath: { path: /sys/module }
      - name: sys-fs
        hostPath: { path: /sys/kernel }
      - name: falco-yaml
        configMap:
          name: falco
          items:
          - key: falco.yaml
            path: falco.yaml
---
# ---------------------------------------------------------
# FALCOSIDEKICK DEPLOYMENT
# ---------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: falcosidekick
  namespace: falco
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: falcosidekick
  template:
    metadata:
      labels:
        app.kubernetes.io/name: falcosidekick
        app.kubernetes.io/instance: falcosidekick
        app.kubernetes.io/component: core
    spec:
      serviceAccountName: falcosidekick
      containers:
      - name: falcosidekick
        image: docker.io/falcosecurity/falcosidekick:2.32.0
        ports:
        - containerPort: 2801
          name: http
        - containerPort: 2810
          name: http-notls
---
# ---------------------------------------------------------
# FALCOSIDEKICK SERVICE
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: falcosidekick
  namespace: falco
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: falcosidekick
  ports:
  - name: http
    port: 2801
    targetPort: http
  - name: http-notls
    port: 2810
    targetPort: http-notls
---
# ---------------------------------------------------------
# PROMTAIL SERVICEACCOUNT
# ---------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loki-promtail
  namespace: monitoring
---
# ---------------------------------------------------------
# PROMTAIL CLUSTERROLE
# ---------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: loki-promtail
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs:
  - get
  - watch
  - list
---
# ---------------------------------------------------------
# PROMTAIL CLUSTERROLEBINDING
# ---------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: loki-promtail
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: loki-promtail
subjects:
- kind: ServiceAccount
  name: loki-promtail
  namespace: monitoring
---
# ---------------------------------------------------------
# PROMTAIL SECRET (PLAINTEXT promtail.yaml â€“ static /var/log/pods)
# ---------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: loki-promtail
  namespace: monitoring
type: Opaque
stringData:
  promtail.yaml: |-
    server:
      log_level: debug
      log_format: logfmt
      http_listen_port: 3101
      grpc_listen_port: 0

    positions:
      filename: /run/promtail/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      - job_name: pods-static
        pipeline_stages:
          - cri: {}
        static_configs:
          - targets:
              - localhost
            labels:
              job: pods-static
              __path__: /var/log/pods/*/*/*.log
---
# ---------------------------------------------------------
# PROMTAIL DAEMONSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: loki-promtail
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: promtail
  template:
    metadata:
      labels:
        app.kubernetes.io/name: promtail
        app.kubernetes.io/instance: loki
    spec:
      serviceAccountName: loki-promtail
      containers:
      - name: promtail
        image: docker.io/grafana/promtail:3.5.1
        args:
        - -config.file=/etc/promtail/promtail.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: run
          mountPath: /run/promtail
        - name: containers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: pods
          mountPath: /var/log/pods
          readOnly: true
      volumes:
      - name: config
        secret:
          secretName: loki-promtail
      - name: run
        hostPath:
          path: /run/promtail
      - name: containers
        hostPath:
          path: /var/lib/docker/containers
      - name: pods
        hostPath:
          path: /var/log/pods
---
# ---------------------------------------------------------
# LOKI STATEFULSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
      release: loki
  serviceName: loki-headless
  template:
    metadata:
      labels:
        app: loki
        release: loki
    spec:
      serviceAccountName: loki
      securityContext:
        fsGroup: 10001
        runAsUser: 10001
        runAsGroup: 10001
        runAsNonRoot: true
      containers:
      - name: loki
        image: grafana/loki:2.6.1
        args:
        - -config.file=/etc/loki/loki.yaml
        ports:
        - name: http-metrics
          containerPort: 3100
        - name: grpc
          containerPort: 9095
        - name: memberlist-port
          containerPort: 7946
        readinessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: tmp
          mountPath: /tmp
        - name: storage
          mountPath: /data
      volumes:
      - name: config
        secret:
          secretName: loki
      - name: tmp
        emptyDir: {}
      - name: storage
        emptyDir: {}
---
# ---------------------------------------------------------
# LOKI SERVICE
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: loki
  namespace: monitoring
spec:
  type: ClusterIP
  selector:
    app: loki
    release: loki
  ports:
  - name: http-metrics
    port: 3100
    targetPort: http-metrics
    protocol: TCP

