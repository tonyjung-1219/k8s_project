# ---------------------------------------------------------
# NAMESPACES
# ---------------------------------------------------------
apiVersion: v1
kind: Namespace
metadata:
  name: falco
---
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
---
# ---------------------------------------------------------
# FALCO CONFIGMAP (falco.yaml)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco
  namespace: falco
data:
  falco.yaml: |-
    append_output:
    - suggested_output: true
    base_syscalls:
      all: false
      custom_set: []
      repair: false
    buffer_format_base64: false
    buffered_outputs: false
    capture:
      default_duration: 5000
      enabled: false
      mode: rules
      path_prefix: /tmp/falco
    config_files:
    - /etc/falco/config.d
    engine:
      ebpf:
        buf_size_preset: 4
        drop_failed_exit: false
        probe: ${HOME}/.falco/falco-bpf.o
      kind: modern_ebpf
      kmod:
        buf_size_preset: 4
        drop_failed_exit: false
      modern_ebpf:
        buf_size_preset: 4
        cpus_for_each_buffer: 2
        drop_failed_exit: false
    falco_libs:
      snaplen: 80
      thread_table_auto_purging_interval_s: 300
      thread_table_auto_purging_thread_timeout_s: 300
      thread_table_size: 262144
    file_output:
      enabled: false
      filename: ./events.txt
      keep_alive: false
    grpc:
      bind_address: unix:///run/falco/falco.sock
      enabled: false
      threadiness: 0
    grpc_output:
      enabled: false
    http_output:
      ca_bundle: ""
      ca_cert: ""
      ca_path: /etc/falco/certs/
      client_cert: /etc/falco/certs/client/client.crt
      client_key: /etc/falco/certs/client/client.key
      compress_uploads: false
      echo: false
      enabled: false
      insecure: false
      keep_alive: false
      max_consecutive_timeouts: 5
      mtls: false
      url: ""
      user_agent: falcosecurity/falco
    json_include_message_property: false
    json_include_output_fields_property: true
    json_include_output_property: true
    json_include_tags_property: true
    json_output: true
    libs_logger:
      enabled: true
      severity: info
    load_plugins:
    - container
    log_level: info
    log_stderr: true
    log_syslog: true
    metrics:
      enabled: false
    output_timeout: 2000
    outputs_queue:
      capacity: 0
    plugins:
    - init_config:
        engines:
          bpm:
            enabled: true
          containerd:
            enabled: true
            sockets:
            - /run/host-containerd/containerd.sock
          cri:
            enabled: true
            sockets:
            - /run/containerd/containerd.sock
            - /run/crio/crio.sock
            - /run/k3s/containerd/containerd.sock
            - /run/host-containerd/containerd.sock
          docker:
            enabled: true
            sockets:
            - /var/run/docker.sock
          libvirt_lxc:
            enabled: true
          lxc:
            enabled: true
          podman:
            enabled: true
            sockets:
            - /run/podman/podman.sock
        hooks:
        - create
        label_max_len: 100
        with_size: false
      library_path: libcontainer.so
      name: container
    plugins_hostinfo: true
    priority: debug
    program_output:
      enabled: false
      keep_alive: false
      program: 'jq ''{text: .output}'' | curl -d @- -X POST https://hooks.slack.com/services/XXX'
    rule_matching: first
    rules_files:
    - /etc/falco/falco_rules.yaml
    - /etc/falco/falco_rules.local.yaml
    - /etc/falco/rules.d
    stdout_output:
      enabled: true
    syscall_event_drops:
      actions:
      - log
      - alert
      max_burst: 1
      rate: 0.03333
      simulate_drops: false
      threshold: 0.1
    syscall_event_timeouts:
      max_consecutives: 1000
    syslog_output:
      enabled: true
    time_format_iso_8601: false
    watch_config_files: true
    webserver:
      enabled: true
      k8s_healthz_endpoint: /healthz
      listen_address: 0.0.0.0
      listen_port: 8765
      prometheus_metrics_enabled: true
      ssl_certificate: /etc/falco/falco.pem
      ssl_enabled: false
      threadiness: 0
---
# ---------------------------------------------------------
# FALCO SERVICE ACCOUNTS
# ---------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: falco
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falcosidekick
  namespace: falco
---
# ---------------------------------------------------------
# FALCO DAEMONSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: falco
      app.kubernetes.io/name: falco
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: falco
        app.kubernetes.io/name: falco
    spec:
      serviceAccountName: falco
      containers:
      - name: falco
        image: docker.io/falcosecurity/falco:0.42.1
        imagePullPolicy: IfNotPresent
        args: ["/usr/bin/falco"]
        env:
        - name: HOST_ROOT
          value: /host
        - name: FALCO_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: FALCO_K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        ports:
        - name: web
          containerPort: 8765
        securityContext:
          privileged: true
        volumeMounts:
        - name: container-engine-socket-0
          mountPath: /host/var/run/docker.sock
        - name: container-engine-socket-1
          mountPath: /host/run/podman/podman.sock
        - name: container-engine-socket-2
          mountPath: /host/run/host-containerd/containerd.sock
        - name: container-engine-socket-3
          mountPath: /host/run/containerd/containerd.sock
        - name: container-engine-socket-4
          mountPath: /host/run/crio/crio.sock
        - name: container-engine-socket-5
          mountPath: /host/run/k3s/containerd/containerd.sock
        - name: specialized-falco-configs
          mountPath: /etc/falco/config.d
        - name: root-falco-fs
          mountPath: /root/.falco
        - name: proc-fs
          mountPath: /host/proc
        - name: etc-fs
          mountPath: /host/etc
          readOnly: true
        - name: dev-fs
          mountPath: /host/dev
          readOnly: true
        - name: sys-module-fs
          mountPath: /sys/module
        - name: sys-fs
          mountPath: /sys/kernel
          readOnly: true
        - name: falco-yaml
          mountPath: /etc/falco/falco.yaml
          subPath: falco.yaml
      initContainers:
      - name: falco-driver-loader
        image: docker.io/falcosecurity/falco-driver-loader:0.42.1
        securityContext:
          privileged: true
        args: ["auto"]
        env:
        - name: HOST_ROOT
          value: /host
        volumeMounts:
        - name: root-falco-fs
          mountPath: /root/.falco
      volumes:
      - name: container-engine-socket-0
        hostPath:
          path: /var/run/docker.sock
      - name: container-engine-socket-1
        hostPath:
          path: /run/podman/podman.sock
      - name: container-engine-socket-2
        hostPath:
          path: /run/host-containerd/containerd.sock
      - name: container-engine-socket-3
        hostPath:
          path: /run/containerd/containerd.sock
      - name: container-engine-socket-4
        hostPath:
          path: /run/crio/crio.sock
      - name: container-engine-socket-5
        hostPath:
          path: /run/k3s/containerd/containerd.sock
      - name: specialized-falco-configs
        emptyDir: {}
      - name: root-falco-fs
        emptyDir: {}
      - name: proc-fs
        hostPath:
          path: /proc
      - name: etc-fs
        hostPath:
          path: /etc
      - name: dev-fs
        hostPath:
          path: /dev
      - name: sys-module-fs
        hostPath:
          path: /sys/module
      - name: sys-fs
        hostPath:
          path: /sys/kernel
      - name: falco-yaml
        configMap:
          name: falco
          items:
          - key: falco.yaml
            path: falco.yaml
---
# ---------------------------------------------------------
# FALCOSIDEKICK DEPLOYMENT
# ---------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: falcosidekick
  namespace: falco
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: falcosidekick
  template:
    metadata:
      labels:
        app.kubernetes.io/name: falcosidekick
        app.kubernetes.io/instance: falcosidekick
        app.kubernetes.io/component: core
    spec:
      serviceAccountName: falcosidekick
      containers:
      - name: falcosidekick
        image: docker.io/falcosecurity/falcosidekick:2.32.0
        ports:
        - containerPort: 2801
          name: http
        - containerPort: 2810
          name: http-notls
---
# ---------------------------------------------------------
# FALCOSIDEKICK SERVICE
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: falcosidekick
  namespace: falco
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: falcosidekick
  ports:
  - name: http
    port: 2801
    targetPort: http
  - name: http-notls
    port: 2810
    targetPort: http-notls
---
# ---------------------------------------------------------
# PROMTAIL SERVICEACCOUNT
# ---------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loki-promtail
  namespace: monitoring
---
# ---------------------------------------------------------
# PROMTAIL CLUSTERROLE
# ---------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: loki-promtail
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs:
  - get
  - watch
  - list
---
# ---------------------------------------------------------
# PROMTAIL CLUSTERROLEBINDING
# ---------------------------------------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: loki-promtail
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: loki-promtail
subjects:
- kind: ServiceAccount
  name: loki-promtail
  namespace: monitoring
---
# ---------------------------------------------------------
# PROMTAIL SECRET (promtail.yaml – /var/log/pods)
# ---------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: loki-promtail
  namespace: monitoring
type: Opaque
stringData:
  promtail.yaml: |-
    server:
      log_level: info
      log_format: logfmt
      http_listen_port: 3101
      grpc_listen_port: 0

    positions:
      filename: /run/promtail/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      - job_name: pods-static
        pipeline_stages:
          - cri: {}
          - json:
              expressions:
                output: output
                priority: priority
                rule: rule
                tags: tags
                hostname: hostname
                time: time
          - labels:
              priority:
              rule:
              hostname:
          - output:
              source: output

        static_configs:
          - targets:
              - localhost
            labels:
              job: pods-static
              __path__: /var/log/pods/*/*/*.log
---
# ---------------------------------------------------------
# PROMTAIL DAEMONSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: loki-promtail
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: promtail
  template:
    metadata:
      labels:
        app.kubernetes.io/name: promtail
        app.kubernetes.io/instance: loki
    spec:
      serviceAccountName: loki-promtail
      containers:
      - name: promtail
        image: docker.io/grafana/promtail:3.5.1
        args:
        - -config.file=/etc/promtail/promtail.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: run
          mountPath: /run/promtail
        - name: containers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: pods
          mountPath: /var/log/pods
          readOnly: true
      volumes:
      - name: config
        secret:
          secretName: loki-promtail
      - name: run
        hostPath:
          path: /run/promtail
      - name: containers
        hostPath:
          path: /var/lib/docker/containers
      - name: pods
        hostPath:
          path: /var/log/pods
---
# ---------------------------------------------------------
# LOKI SERVICEACCOUNT
# ---------------------------------------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loki
  namespace: monitoring
---
# ---------------------------------------------------------
# LOKI CONFIG SECRET
# ---------------------------------------------------------
apiVersion: v1
kind: Secret
metadata:
  name: loki
  namespace: monitoring
type: Opaque
stringData:
  loki.yaml: |-
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9095

    memberlist:
      join_members:
      - loki-headless.monitoring.svc.cluster.local:7946

    ingester:
      lifecycler:
        address: 127.0.0.1
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
        final_sleep: 0s
      chunk_idle_period: 5m
      max_chunk_age: 1h
      chunk_target_size: 1536000
      chunk_retain_period: 30s
      wal:
        enabled: false

    limits_config:
      ingestion_rate_mb: 4
      ingestion_burst_size_mb: 6
      max_cache_freshness_per_query: 10m
      max_entries_limit_per_query: 5000

    schema_config:
      configs:
      - from: 2020-10-24
        store: boltdb-shipper
        object_store: filesystem
        schema: v11
        index:
          prefix: index_
          period: 24h

    storage_config:
      boltdb_shipper:
        active_index_directory: /data/index
        cache_location: /data/index_cache
        shared_store: filesystem
      filesystem:
        directory: /data/chunks

    querier:
      max_concurrent: 20

    query_range:
      parallelise_shardable_queries: true
      cache_results: false

    compactor:
      working_directory: /data/compactor
      shared_store: filesystem

    ruler:
      storage:
        type: local
        local:
          directory: /tmp/rules
      rule_path: /tmp/rules-temp
      ring:
        kvstore:
          store: inmemory
      alertmanager_url: ""
---
# ---------------------------------------------------------
# LOKI STATEFULSET
# ---------------------------------------------------------
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
      release: loki
  serviceName: loki-headless
  template:
    metadata:
      labels:
        app: loki
        release: loki
    spec:
      serviceAccountName: loki
      securityContext:
        fsGroup: 10001
        runAsUser: 10001
        runAsGroup: 10001
        runAsNonRoot: true
      containers:
      - name: loki
        image: grafana/loki:2.6.1
        args:
        - -config.file=/etc/loki/loki.yaml
        ports:
        - name: http-metrics
          containerPort: 3100
        - name: grpc
          containerPort: 9095
        - name: memberlist-port
          containerPort: 7946
        readinessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 45
          periodSeconds: 10
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: tmp
          mountPath: /tmp
        - name: storage
          mountPath: /data
      volumes:
      - name: config
        secret:
          secretName: loki
      - name: tmp
        emptyDir: {}
      - name: storage
        emptyDir: {}
---
# ---------------------------------------------------------
# LOKI SERVICE (Grafana에서 붙는 엔드포인트)
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: loki
  namespace: monitoring
spec:
  type: ClusterIP
  selector:
    app: loki
    release: loki
  ports:
  - name: http-metrics
    port: 3100
    targetPort: http-metrics
    protocol: TCP
---
# ---------------------------------------------------------
# LOKI HEADLESS SERVICE (StatefulSet용)
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: loki-headless
  namespace: monitoring
spec:
  clusterIP: None
  selector:
    app: loki
    release: loki
  ports:
  - name: memberlist-port
    port: 7946
    targetPort: memberlist-port
    protocol: TCP
---
# ---------------------------------------------------------
# GRAFANA: DATASOURCE & DASHBOARD PROVISIONING
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource-loki
  namespace: monitoring
data:
  loki-datasource.yaml: |-
    apiVersion: 1
    datasources:
      - name: Loki
        type: loki
        access: proxy
        uid: loki
        url: http://loki:3100
        isDefault: true
        jsonData:
          maxLines: 1000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider-falcoloki
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  dashboards.yaml: |-
    apiVersion: 1
    providers:
      - name: 'falco-loki'
        type: file
        disableDeletion: false
        editable: true
        folder: 'Falco-Loki'
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-falcoloki
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  falco-loki-dashboard.json: |-
    {
      "id": null,
      "uid": "falco-loki-main",
      "title": "Falco + Loki Security Overview",
      "tags": ["falco", "loki"],
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "10s",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": ["5s","10s","30s","1m","5m","15m","30m","1h"],
        "time_options": ["5m","15m","30m","1h","6h","12h","24h","2d","7d","30d"]
      },
      "templating": {
        "list": [
          {
            "name": "rule",
            "type": "query",
            "label": "Falco rule",
            "hide": 0,
            "refresh": 1,
            "datasource": {
              "type": "loki",
              "uid": "loki"
            },
            "query": "label_values({rule=~\".+\"}, rule)",
            "definition": "",
            "current": {
              "text": "All",
              "value": "",
              "selected": false
            },
            "multi": true,
            "includeAll": true,
            "options": []
          }
        ]
      },
      "panels": [
        {
          "id": 1,
          "title": "Falco logs (live)",
          "type": "logs",
          "gridPos": { "h": 14, "w": 24, "x": 0, "y": 0 },
          "options": {
            "showLabels": true,
            "showTime": true,
            "wrapLogMessage": true,
            "sortOrder": "Descending",
            "dedupStrategy": "none"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "{rule=~\"$rule|.+\"}"
            }
          ],
          "datasource": {
            "type": "loki",
            "uid": "loki"
          }
        },
        {
          "id": 2,
          "title": "Top Falco rules (count over 5m)",
          "type": "table",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 14 },
          "options": {
            "showHeader": true
          },
          "transformations": [
            {
              "id": "labelsToFields",
              "options": {
                "mode": "columns"
              }
            }
          ],
          "fieldConfig": {
            "defaults": {},
            "overrides": []
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum by (rule) (count_over_time({rule=~\"$rule|.+\"}[5m]))",
              "legendFormat": "{{rule}}",
              "instant": true
            }
          ],
          "datasource": {
            "type": "loki",
            "uid": "loki"
          }
        }
      ]
    }
---
# ---------------------------------------------------------
# GRAFANA DEPLOYMENT + SERVICE
# ---------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
        runAsUser: 472
      containers:
      - name: grafana
        image: grafana/grafana:10.4.1
        ports:
        - containerPort: 3000
          name: http
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: admin
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: admin
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasource-loki
          mountPath: /etc/grafana/provisioning/datasources
          readOnly: true
        - name: grafana-dashboard-provider-falcoloki
          mountPath: /etc/grafana/provisioning/dashboards
          readOnly: true
        - name: grafana-dashboard-falcoloki
          mountPath: /var/lib/grafana/dashboards
          readOnly: true

      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-datasource-loki
        configMap:
          name: grafana-datasource-loki
      - name: grafana-dashboard-provider-falcoloki
        configMap:
          name: grafana-dashboard-provider-falcoloki
      - name: grafana-dashboard-falcoloki
        configMap:
          name: grafana-dashboard-falcoloki
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  type: NodePort
  selector:
    app: grafana
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 32000
    name: http
